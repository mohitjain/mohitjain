<!DOCTYPE html>
<html>
  <head>
      <meta charset="utf-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />

      <title>How to fetch and parse emails in ruby on rails</title>
      <meta name="description" content="Every Dog has one Blog" />

      <meta name="HandheldFriendly" content="True" />
      <meta name="MobileOptimized" content="320" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />

      <link rel="alternate" type="application/rss+xml" href="http://codebeerstartups.com/feed.xml">
      <link rel="shortcut icon" href="/favicon.ico">
      <link rel="prefetch" href="http://codebeerstartups.com">
      <link rel="canonical" href="http://codebeerstartups.com/2013/01/how-to-fetch-and-parse-emails-in-ruby-on-rails/">

      <link rel="stylesheet" href="/assets/css/init.css">
      <link href='//fonts.googleapis.com/css?family=Domine:700|Open+Sans:400,600|Source+Code+Pro:500' rel='stylesheet' type='text/css'>
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  </head>
  <body>

    <header class="title">
    <a href="http://codebeerstartups.com"><i class="fa fa-bookmark-o fa-lg"></i><span>Codebeerstartups</span></a>
</header>

<nav class="wrapper  ">
    <a href="#" onclick="return false;"><i class="fa fa-navicon fa-lg"></i></a>
    <ul>
        
            <li><a href="/about/">About</a></li>
        
            
        
            <li><a href="/contact/">Contact</a></li>
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    </ul>
</nav>

    <div class="index">
    <div class="wrapper">
        <h1 class="right">How to fetch and parse emails in ruby on rails</h1>
        <h2 class="left">Introduction</h2>
    </div>
</div>

<div class="profile ">
    <img src="/assets/img/author.jpg" class="profileimage" alt="user">
    <h4>Mohit Jain</h4>
    <ul>
    	
        <li><a href="http://twitter.com/jainmohit27" class="smallsocialbutton twitter" target="_blank"><i class="fa fa-twitter"></i></a></li>
        
        
        <li><a href="http://facebook.com/jain.mohit27" class="smallsocialbutton facebook" target="_blank"><i class="fa fa-facebook"></i></a></li>
        
        
        <li><a href="http://github.com/mohitjain" class="smallsocialbutton github" target="_blank"><i class="fa fa-github"></i></a></li>
        
        
        <li><a href="http://codebeerstartups.com/feed.xml" class="smallsocialbutton rss" target="_blank"><i class="fa fa-rss"></i></a></li>
    </ul>
    <p>Rails Developer</p>
    <hr>
</div>

<div id="cover" class="cover ">
    <div class="background" style="background-image:url('');"></div>
    <header class="wrapper">
        <h2>
        	
				quick-solution
          	
				tips-and-tricks
          	
        </h2>
        <h1><a href="/2013/01/how-to-fetch-and-parse-emails-in-ruby-on-rails/">How to fetch and parse emails in ruby on rails</a></h1>
        <span>
            Posted by <a href="http://codebeerstartups.com" target="_blank">Mohit Jain</a>
                on <i class="fa fa-clock-o"></i> <time datetime="2013-01-18">January 18, 2013</time>.
        </span>
    </header>
    <i class="fa fa-chevron-down movedown"></i>
</div>

<section class="posts wrapper">
    <article class="post ">

        <header>
            <div class="feature"><span>Featured</span><i class="fa fa-bookmark fa-lg"></i></div>
            <h2>
            	
					quick-solution
          		
					tips-and-tricks
          		
            </h2>
            <h1 id="posttitle"><a href="#">How to fetch and parse emails in ruby on rails</a></h1>
            <span>
                Posted by <a href="" target="_blank">Mohit Jain</a>
                on <i class="fa fa-clock-o"></i> <time datetime="2013-01-18">January 18, 2013</time>.
            </span>
        </header>

        <section class="postbody">
            <p>Last weekend I was working on an mini hackathon and launched a group emailing service. <a href="http://emaillist.io/?utm_source=codebeerstartups&amp;utm_medium=blogpost&amp;utm_campaign=codebeerstartups">EmailList.io</a>. The task was to setup an email server, how to fetch and parse emails in ruby on rails forward it to respective group members. Last part was pretty simple. In this post I am just talking about “How to fetch and parse emails in ruby on rails.”</p>

<p>To fetch email using POP/IMAP you check out a gem ie <a href="https://github.com/titanous/mailman">mailman</a>.
Here is the sample code for the same:</p>

<ol>
  <li>Install the gem</li>
  <li>Create a script file in scripts folder ie mailman_server and just paste the code below,
which itself is pretty clear. Check inline comments.</li>
</ol>

<!--more-->

<h2 id="basic-parsing">Basic Parsing</h2>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="nb">require</span> <span class="s2">"bundler/setup"</span>
<span class="nb">require</span> <span class="s2">"mailman"</span>
<span class="c1">#Mailman.config.logger = Logger.new("log/mailman.log")  # uncomment this if you can want to create a log file</span>
<span class="no">Mailman</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">poll_interval</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># change this number as per your needs. Default is 60 seconds</span>
<span class="no">Mailman</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">pop3</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">server: </span><span class="s1">'pop.gmail.com'</span><span class="p">,</span> <span class="ss">port: </span><span class="mi">995</span><span class="p">,</span> <span class="ss">ssl: </span><span class="kp">true</span><span class="p">,</span>
  <span class="ss">username: </span><span class="s2">"GMAIL_USERNAME"</span><span class="p">,</span>
  <span class="ss">password: </span><span class="s2">"GMAIL_PASSWORD"</span>
<span class="p">}</span>
  <span class="no">Mailman</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">run</span> <span class="k">do</span>
  <span class="n">default</span> <span class="k">do</span>
    <span class="k">begin</span>
    <span class="nb">p</span> <span class="s2">"Found a new message"</span>
    <span class="nb">p</span> <span class="n">message</span><span class="p">.</span><span class="nf">from</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># message.from is an array</span>
    <span class="nb">p</span> <span class="n">message</span><span class="p">.</span><span class="nf">to</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># message.to is an array again..</span>
    <span class="nb">p</span> <span class="n">message</span><span class="p">.</span><span class="nf">subject</span>
    <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="no">Mailman</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">error</span> <span class="s2">"Exception occurred while receiving message:n</span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">"</span>
      <span class="no">Mailman</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">error</span> <span class="p">[</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">.</span><span class="nf">backtrace</span><span class="p">].</span><span class="nf">join</span><span class="p">(</span><span class="s2">"n"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>So far its pretty easy, but the question is how to parse the email body as html, text and parse attachments. Now take a look on this. Pretty simple.</p>

<h2 id="get-attachments-html-and-text-body">Get attachments, HTML and Text Body</h2>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">if</span> <span class="n">message</span><span class="p">.</span><span class="nf">multipart?</span>
  <span class="n">email_html</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="nf">html_part</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">decoded</span>  <span class="c1">#parsing of html content of the email</span>
  <span class="n">email_text</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="nf">text_part</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">decoded</span>  <span class="c1"># parsing of text content of the email</span>
  <span class="n">email_attachments</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># an array which can be used to store object records of the attachments..</span>
  <span class="n">message</span><span class="p">.</span><span class="nf">attachments</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attachment</span><span class="o">|</span>
    <span class="n">file</span> <span class="o">=</span> <span class="no">StringIO</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">attachment</span><span class="p">.</span><span class="nf">decoded</span><span class="p">)</span>
    <span class="n">file</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">class_eval</span> <span class="p">{</span> <span class="kp">attr_accessor</span> <span class="ss">:original_filename</span><span class="p">,</span> <span class="ss">:content_type</span> <span class="p">}</span>
    <span class="n">file</span><span class="p">.</span><span class="nf">original_filename</span> <span class="o">=</span> <span class="n">attachment</span><span class="p">.</span><span class="nf">filename</span>
    <span class="n">file</span><span class="p">.</span><span class="nf">content_type</span> <span class="o">=</span> <span class="n">attachment</span><span class="p">.</span><span class="nf">mime_type</span>
    <span class="n">attachment</span> <span class="o">=</span> <span class="no">Attachment</span><span class="p">.</span><span class="nf">new</span>    <span class="c1"># an attachment model and all the attachments are saved here...</span>
    <span class="n">attachment</span><span class="p">.</span><span class="nf">attached_file</span> <span class="o">=</span> <span class="n">file</span>
    <span class="n">attachment</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">email_attachments</span> <span class="o">&lt;&lt;</span> <span class="n">attachment</span>   <span class="c1"># adding all attachment objects one by one in the array...</span>
  <span class="k">end</span>
<span class="k">else</span>
  <span class="n">email_html</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">decoded</span>    <span class="c1"># in this case its a plain email so html body is same as text body..</span>
  <span class="n">email_text</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">decoded</span>
  <span class="n">email_attachments</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># no attachments :)</span>
<span class="k">end</span></code></pre></figure>

<p>Once you have parsed all the attributes from the email ie to, from, email attachments now you can easily pass it to delayed job or something like creating a ticket or what ever you want to do as per you needs ;)</p>

<p>If you are facing any issues. Checkout the source code files at <a href="https://github.com/mohitjain/mailman_example_code">github</a>. Still if you have any doubts contact me or you can comment on the blog post itself.</p>


        </section>

        <footer>
            <ul class="share left">
                <li><a href="http://twitter.com/share?text=How to fetch and parse emails in ruby on rails&url=http://codebeerstartups.com/2013/01/how-to-fetch-and-parse-emails-in-ruby-on-rails/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" class="smallbutton lightgray"><i class="fa fa-twitter"></i>Twitter</a></li>
                <li><a href="https://www.facebook.com/sharer/sharer.php?u=http://codebeerstartups.com/2013/01/how-to-fetch-and-parse-emails-in-ruby-on-rails/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" class="smallbutton lightgray"><i class="fa fa-facebook"></i>Facebook</a></li>
            </ul>
        </footer>

        <div class="postprofile">
            <img src="/assets/img/author.jpg" class="author" alt="user">
            <div class="info">
                <h4>Mohit Jain</h4>
                <a href="http://codebeerstartups.com">http://codebeerstartups.com</a>
                <p>Rails Developer</p>
                <ul class="social">
       				
                    <li><a href="http://twitter.com/jainmohit27" class="twitter" target="_blank"><i class="fa fa-twitter"></i></a></li>
                    
					
                    <li><a href="http://facebook.com/jain.mohit27" class="facebook" target="_blank"><i class="fa fa-facebook"></i></a></li>
                    
					
                    <li><a href="http://github.com/mohitjain" class="github" target="_blank"><i class="fa fa-github-alt"></i></a></li>
                    
					
					
					
                    <li><a href="https://plus.google.com/+MohitJain27" class="googleplus" target="_blank"><i class="fa fa-google-plus"></i></a></li>
					
					
					
                    <li><a href="https://www.pinterest.com/mohitjain27/" class="pinterest" target="_blank"><i class="fa fa-pinterest"></i></a></li>
					
					
                    <li><a href="https://www.linkedin.com/profile/view?id=40603170" class="linkedin" target="_blank"><i class="fa fa-linkedin"></i></a></li>
					
                    <li><a href="http://codebeerstartups.com/feed.xml" class="rss" target="_blank"><i class="fa fa-rss"></i></a></li>
                </ul>
            </div>
        </div>


        <div class="comments">
            <a href="javascript:;" class="readmore smallbutton blue"><i class="fa fa-comments"></i>View Comments...</a>
            <div id="disqus_thread"></div>
            <div id="g-comments"></div>
        </div>

    </article>

</section>


    <footer class="wrapper">
    <div class="smallnav">
    	
        	<a href="/about/">About</a> &bull;
        
        	
        
        	<a href="/contact/">Contact</a> &bull;
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
        	
        
    </div>
    <div>
        Copyright &copy; <a href="http://codebeerstartups.com/">Codebeerstartups</a>. 2014 &bull; All rights reserved.
        <span class="ghost">Proudly published with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a>.</span>
    </div>
</footer>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript">
      var config = {
        'disqus_shortname': 'codebeerstartups',
        'google_comments': false,
        'analytics_id': 'UA-30450850-3',
        'analytics_domain': 'codebeerstartups.com',
        'readingtime': true,
        'autoload_comments': true
      };
    </script>
    <script async type="text/javascript" src="/assets/js/theme.min.js"></script>

  </body>
</html>